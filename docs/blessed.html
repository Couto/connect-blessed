<!DOCTYPE html>

<html>
<head>
  <title>blessed.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="blessed.html">
                blessed.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>blessed.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">toNetmask</span> <span class="params">(n)</span> {</span>
    <span class="keyword">return</span> parseInt(<span class="keyword">new</span> Array(n + <span class="number">1</span>).join(<span class="string">'1'</span>) + (<span class="keyword">new</span> Array(<span class="number">33</span> - n).join(<span class="string">'0'</span>)), <span class="number">2</span>);
}

<span class="function"><span class="keyword">function</span> <span class="title">validIPv4</span> <span class="params">(cidrs, ip)</span> {</span>
    <span class="keyword">var</span> i_bytes = ip.split(<span class="string">'.'</span>);
    <span class="keyword">var</span> i_bin = <span class="number">0</span>;
    <span class="keyword">for</span> (b = <span class="number">0</span>; b &lt; i_bytes.length; b++) {
        i_bytes[b] = parseInt(i_bytes[b], <span class="number">10</span>);
        i_bin += Math.pow(<span class="number">256</span>, <span class="number">3</span> - b) * i_bytes[b];
    }

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cidrs.length; ++i) {
        <span class="keyword">var</span> cidr = cidrs[i];
        <span class="keyword">var</span> tmp  = cidr.split(<span class="string">'/'</span>);

        <span class="keyword">var</span> c_network = tmp[<span class="number">0</span>];
        <span class="keyword">var</span> c_bits    = parseInt(tmp[<span class="number">1</span>], <span class="number">10</span>);
        <span class="keyword">var</span> c_bytes   = c_network.split(<span class="string">'.'</span>);
        <span class="keyword">var</span> c_bin     = <span class="number">0</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> b = <span class="number">0</span>; b &lt; c_bytes.length; ++b) {
            c_bytes[b] = parseInt(c_bytes[b], <span class="number">10</span>);
            c_bin += Math.pow(<span class="number">256</span>, <span class="number">3</span> - b) * c_bytes[b];
        }

        console.log(c_bytes, c_bin, c_bits, toNetmask(c_bits), i_bytes, i_bin);

        <span class="keyword">var</span> mask = toNetmask(c_bits);

        <span class="keyword">if</span> ((c_bin &amp; mask) === (i_bin &amp; mask)) {
            <span class="keyword">return</span> <span class="literal">true</span>;
        }
    }

    <span class="keyword">return</span> <span class="literal">false</span>;
}


module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(cidrs)</span> {</span>
    <span class="string">'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Create an array with n length and fill it with ones.
Create a  second array with 32 - n length and fill it with zeros.
Convert and concat them to strings.
We now possess the model to compare the ip.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> netmask = <span class="function"><span class="keyword">function</span> <span class="params">(n)</span> {</span>
            <span class="keyword">return</span> parseInt(<span class="keyword">new</span> Array(n + <span class="number">1</span>).join(<span class="string">'1'</span>) + (<span class="keyword">new</span> Array(<span class="number">33</span> - n).join(<span class="string">'0'</span>)), <span class="number">2</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Split the 127.0.0.1/32 to get the range byte, assume 32 if it hasn&#39;t a range</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        splitRange = <span class="function"><span class="keyword">function</span> <span class="params">(range)</span> {</span>
            <span class="keyword">return</span> parseInt(range.split(<span class="string">'/'</span>)[<span class="number">1</span>], <span class="number">10</span>) || <span class="number">32</span>;
        },
        isBlessed = <span class="function"><span class="keyword">function</span> <span class="params">(ip)</span> {</span>
            <span class="keyword">var</span> i_bytes = ip.split(<span class="string">'.'</span>);
            <span class="keyword">var</span> i_bin = <span class="number">0</span>;

            <span class="keyword">for</span> (b = <span class="number">0</span>; b &lt; i_bytes.length; b++) {
                i_bytes[b] = parseInt(i_bytes[b], <span class="number">10</span>);
                i_bin += Math.pow(<span class="number">256</span>, <span class="number">3</span> - b) * i_bytes[b];
            }

            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cidrs.length; ++i) {
                <span class="keyword">var</span> cidr = cidrs[i];
                <span class="keyword">var</span> tmp  = cidr.split(<span class="string">'/'</span>);

                <span class="keyword">var</span> c_network = tmp[<span class="number">0</span>];
                <span class="keyword">var</span> c_bits    = parseInt(tmp[<span class="number">1</span>], <span class="number">10</span>);
                <span class="keyword">var</span> c_bytes   = c_network.split(<span class="string">'.'</span>);
                <span class="keyword">var</span> c_bin     = <span class="number">0</span>;

                <span class="keyword">for</span> (<span class="keyword">var</span> b = <span class="number">0</span>; b &lt; c_bytes.length; ++b) {
                    c_bytes[b] = parseInt(c_bytes[b], <span class="number">10</span>);
                    c_bin += Math.pow(<span class="number">256</span>, <span class="number">3</span> - b) * c_bytes[b];
                }

                <span class="keyword">var</span> mask = netmasks[c_bits];

                <span class="keyword">if</span> ((c_bin &amp; mask) === (i_bin &amp; mask)) {
                    <span class="keyword">return</span> <span class="literal">true</span>;
                }
            }

            <span class="keyword">return</span> <span class="literal">false</span>;
        },

        netmasks = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Make sure is an array even if they pass a string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cidrs = [].concat(cidrs);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Generate the netmask table</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cidrs.map(splitRange).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(range)</span> {</span>
        netmasks[range] = netmask(range);
    });


    <span class="keyword">return</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>By calling <code>blessed</code>, the user is saying that the previous
ip ranges are the only ip ranges allowed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        blessed: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(req, resp, next)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>if the connection IP belongs to any ip range
given before, then it&#39;s good to go.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (isBlessed(req.connection.ip)) { next(); }
                <span class="keyword">else</span> {
                    resp.statusCode = <span class="number">403</span>;
                    resp.end();
                }
            };
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>By calling <code>cursed</code>, the user is saying that the previous
ip ranges are forbidden.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cursed: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(req, resp, next)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>if the connection IP belongs to any ip range
given before, then it&#39;s forbidden.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (!isBlessed(req.connection.ip)) { next(); }
                <span class="keyword">else</span> {
                    resp.statusCode = <span class="number">403</span>;
                    resp.end();
                }
            };
        }
    };
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
